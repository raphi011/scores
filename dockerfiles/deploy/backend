ARG GO_VERSION

FROM golang:$GO_VERSION

ARG app_env
ARG backend_url
ARG version
ENV APP_ENV $app_env
ENV BACKEND_URL $backend_url

RUN go get -u github.com/gobuffalo/packr/packr

WORKDIR /scores/backend

COPY ./go.* ./

RUN go mod download

COPY . .

WORKDIR /scores/backend/cmd/api

RUN packr
RUN go install -ldflags="-X main.version=$version"

ENTRYPOINT [ "/go/bin/api" ]
CMD ["-provider", "sqlite3", "-connection", "/srv/scores/scores.db", "-goauth", "/srv/scores/client_secret.json"]

EXPOSE 8080
